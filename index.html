<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solicita√ß√£o de Materiais SAP</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --ml-yellow: #fff159; --bg: #ebebeb; --blue: #3483fa; --text: #333; --green: #00a650; --white: #ffffff; }
        body { background-color: var(--bg); font-family: 'Arial', sans-serif; margin: 0; color: var(--text); }
        
        /* Tela de Identifica√ß√£o */
        #login-screen { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: var(--bg); z-index: 1000; display: flex; align-items: center; justify-content: center; 
        }
        .login-box { 
            background: white; padding: 30px; border-radius: 8px; width: 90%; max-width: 400px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); border-top: 5px solid var(--ml-yellow);
        }
        .login-box h2 { margin-top: 0; color: var(--blue); }
        .login-box input { 
            width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; 
            border-radius: 4px; box-sizing: border-box; font-size: 16px;
        }
        .btn-entrar { 
            width: 100%; background: var(--blue); color: white; border: none; 
            padding: 15px; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 16px;
        }

        /* Layout do Cat√°logo */
        header { 
            background-color: var(--ml-yellow); padding: 10px 5%; display: flex; 
            align-items: center; gap: 20px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
        }
        .search-container { flex-grow: 1; }
        .search-container input { width: 100%; padding: 10px; border: none; border-radius: 2px; outline: none; }
        
        .container { padding: 20px 5%; display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .item-card { background: white; border-radius: 6px; padding: 20px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        .item-title { font-size: 15px; margin: 10px 0; height: 40px; overflow: hidden; }
        .item-stock { font-size: 18px; color: var(--green); font-weight: bold; margin-bottom: 10px; }
        .btn-add { background: var(--blue); color: white; border: none; padding: 12px; border-radius: 4px; cursor: pointer; font-weight: bold; }

        /* Carrinho */
        #modal-cart { 
            display: none; position: fixed; right: 0; top: 0; width: 380px; height: 100%; 
            background: white; z-index: 200; padding: 25px; box-shadow: -5px 0 15px rgba(0,0,0,0.2); 
        }
        .cart-item { padding: 10px 0; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; font-size: 13px; }
        .btn-finish { background: var(--green); color: white; border: none; width: 100%; padding: 15px; cursor: pointer; font-weight: bold; border-radius: 6px; margin-top: 20px; }
        #order-text { background: #f9f9f9; padding: 10px; border: 1px dashed #ccc; margin-top: 15px; font-size: 11px; white-space: pre-wrap; display: none; }
        
        .user-badge { font-size: 12px; color: #555; background: rgba(255,255,255,0.5); padding: 5px 10px; border-radius: 20px; }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-box">
        <h2>Identifica√ß√£o</h2>
        <p style="font-size: 14px; color: #666;">Preencha seus dados para acessar o estoque.</p>
        <input type="text" id="userName" placeholder="Seu Nome Completo">
        <input type="text" id="userEmpresa" placeholder="Empresa">
        <input type="text" id="userCidade" placeholder="Cidade">
        <input type="text" id="userSap" placeholder="Seu SAP (Matr√≠cula)">
        <button class="btn-entrar" onclick="salvarLogin()">ACESSAR MATERIAIS</button>
    </div>
</div>

<header>
    <div class="logo" style="font-weight:bold">SAP<span style="color:var(--blue)">ESTOQUE</span></div>
    <div class="search-container">
        <input type="text" id="searchInput" placeholder="Pesquisar material..." onkeyup="filtrar()">
    </div>
    <div id="userInfo" class="user-badge"></div>
    <div class="cart-icon" onclick="toggleCart()" style="cursor:pointer; position:relative">
        <i class="fas fa-shopping-cart" style="font-size: 24px;"></i>
        <span id="cartCount" style="position:absolute; top:-8px; right:-10px; background:red; color:white; border-radius:50%; padding:2px 6px; font-size:10px">0</span>
    </div>
</header>

<div class="container" id="catalog">
    <p style="grid-column: 1/-1; text-align: center;">Carregando materiais...</p>
</div>

<div id="modal-cart">
    <h3>Minha Solicita√ß√£o</h3>
    <div id="cart-list"></div>
    <button class="btn-finish" onclick="gerarPedido()">COPIAR PEDIDO PARA CHAT</button>
    <div id="order-text"></div>
    <button onclick="toggleCart()" style="width:100%; margin-top:10px; border:none; background:none; cursor:pointer; color:#666">Fechar</button>
</div>

<script>
    const URL_SCRIPT = "https://script.google.com/macros/s/AKfycbzA4B6rIJ-L5B1xUZ9le9cLD9pPP6xwXB6n_Z2k5D6-k-EUtfDm3XNoo4HD4o_jAxHk9g/exec";
    let db = [];
    let cart = [];
    let usuario = {};

    // 1. GEST√ÉO DE LOGIN
    function salvarLogin() {
        usuario = {
            nome: document.getElementById('userName').value,
            empresa: document.getElementById('userEmpresa').value,
            cidade: document.getElementById('userCidade').value,
            sap: document.getElementById('userSap').value
        };

        if(!usuario.nome || !usuario.empresa || !usuario.cidade || !usuario.sap) {
            alert("Por favor, preencha todos os campos.");
            return;
        }

        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('userInfo').innerText = `Ol√°, ${usuario.nome.split(' ')[0]}`;
        loadData();
    }

    // 2. CARGA DE DADOS
    async function loadData() {
        try {
            const response = await fetch(URL_SCRIPT);
            db = await response.json();
            render(db);
        } catch (e) { alert("Erro ao carregar planilha."); }
    }

    function render(list) {
        const catalog = document.getElementById('catalog');
        catalog.innerHTML = list.map(item => `
            <div class="item-card">
                <span style="font-size:11px; color:#999">SAP: ${item.sap}</span>
                <h2 class="item-title">${item.nome}</h2>
                <div style="font-size:12px; color:#666; margin-bottom:10px">${item.centro} | ${item.dp}</div>
                <div class="item-stock">${item.disponivel} <small>${item.unidade}</small></div>
                <button class="btn-add" onclick="addToCart('${item.sap}')">Adicionar</button>
            </div>
        `).join('');
    }

    function filtrar() {
        const q = document.getElementById('searchInput').value.toLowerCase();
        render(db.filter(i => i.nome.toLowerCase().includes(q) || i.sap.toString().includes(q)));
    }

    function addToCart(sap) {
        const item = db.find(i => i.sap == sap);
        const inCart = cart.find(c => c.sap == sap);
        if(inCart) inCart.qtd++; else cart.push({...item, qtd: 1});
        document.getElementById('cartCount').innerText = cart.reduce((t, i) => t + i.qtd, 0);
        updateCart();
    }

    function updateCart() {
        document.getElementById('cart-list').innerHTML = cart.map(i => `
            <div class="cart-item">
                <span><strong>${i.qtd}x</strong> ${i.nome.substring(0,25)}...</span>
                <span>SAP: ${i.sap}</span>
            </div>`).join('');
    }

    function toggleCart() {
        const m = document.getElementById('modal-cart');
        m.style.display = m.style.display === 'block' ? 'none' : 'block';
    }

    // 3. GERA√á√ÉO DO PEDIDO COM DADOS DO SOLICITANTE
    function gerarPedido() {
        if(cart.length === 0) return alert("Carrinho vazio!");

        let t = `üë§ *SOLICITANTE*\n`;
        t += `Nome: ${usuario.nome}\n`;
        t += `SAP: ${usuario.sap} | Empresa: ${usuario.empresa}\n`;
        t += `Cidade: ${usuario.cidade}\n`;
        t += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
        t += `üì¶ *ITENS SOLICITADOS*\n`;
        
        cart.forEach(i => {
            t += `‚Ä¢ ${i.qtd}x | SAP: ${i.sap} - ${i.nome}\n`;
        });
        
        t += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
        t += `üìÖ ${new Date().toLocaleString()}`;

        const box = document.getElementById('order-text');
        box.innerText = t;
        box.style.display = 'block';

        navigator.clipboard.writeText(t).then(() => {
            alert("Pedido e seus dados foram copiados! Cole no Chat.");
        });
    }
</script>
</body>
</html>
